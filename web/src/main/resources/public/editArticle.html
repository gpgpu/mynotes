<!DOCTYPE html>
<html>
<head>
<title>My Team</title>
<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />
<link type="text/css" rel="stylesheet" href="css/jquery-ui-1.10.3.min.css"" />
<link rel="stylesheet" type="text/css" href="css/main.css" />
<link href="css/editor.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="scripts/lib/jquery-2.1.1.min.js"></script>
<script src="scripts/lib/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
<script src="scripts/app/editor.js" type="text/javascript"></script>
    <script src="scripts/app/localdb.js" type="text/javascript"></script>
        
     
</head>
<body>

<div class="lightBg">
<h2 id="articleName"></h2>
</div>

<div id="editorContainer">
<div id="ribbon">
<input type="button" id="btnBold" value="B" />
<input type="button" id="btnUnderline" value="U" />
<input type="button" id="btnItalize" value="I" />
<select id="paragraph">
	<option value='-'>- Paragraph -</option>
	<option value='heading1' class='bold'>Heading 1</option>
	<option value='heading2' class='bold'>Heading 2</option>
	<option value='heading3' class='bold'>Heading 3</option>
	<option value='heading4' class='bold'>Heading 4</option>
	<option value='normal' class='bold'>Normal</option>
</select>

<input type="button" id="btnUl" value="ul" />
<input type="button" id="btnOl" value="ol" />
<input type="button" id="btnTable" value="Table" />
<input type="button" id="btnOpenImageDialog" value="Image" />
<select id='coding'>
	<option value='-'>- Coding Style -</option>
	<option value='code' class="bold">Code</option>
	<option value='badCode' class='bold'>Bad Code</option>
	<option value='script' class="bold">Script</option>
</select>
</div>

<div>
<input type="button" id="btnSaveContent" value="Save" />
<span id="saveIndicator"></span>
<input type="button" id="btnHTML" value="HTML" onclick="btnHTML_Click()" />
<input type="button" id="btnText" value="Text" onclick="btnText_Click()" />
<input type="button" id="btnClear" value="Clear" onclick="btnClear_Click()" />

<input type="button" id="btnShowHeightDialog" value="Change Height" onclick="btnShowHeightDialog_Click()" />
<input type="button" id="btnUnescape" value="unescape" />
</div>
<div id="contentArea" contenteditable="true">

</div>

</div>

<div id="diaChangeHeight">
set new height:
<input type="text" id="tbxNewHeight" style="width:100px;" />
<input type="button" id="btnSaveNewHeight" value="Save" onclick="btnSaveNewHeight_Click()" />

</div>

<div id="dialogInsertTable">
Columns: <input type="text" id="tbxTableColumns" />&nbsp;&nbsp;&nbsp;Rows: <input type="text" id="tbxTableRows" /> <br />
<input type="checkbox" id="cbxHasHeader" checked="checked" /> Include Header <br /><br />

<input type="button" id="btnCreateTable" value="Create" />&nbsp;&nbsp;
<input type="button" id="btnCancelTable" value="Cancel" />

</div>



<div id="dialogInsertImage">
	<div id="fileInputContainer"></div>
</div>

 <script type="text/javascript">
    $(function(){
  	  $.ajaxSetup({cache: false});
  	  var articleId = window.opener.targetArticleId;
  	var httpConfig = {headers:{
    	'x-auth-token': sessionStorage.token
    }}
  	  
  	 InitInlineStyleButtons();
     InitBlockStyleButtons();

     $(document).on("click", "#btnUnescape", function(){
       
        var rawContents = $("#contentArea").html();
        $("#contentArea").html(unescape(rawContents));
     });


        var localCopy =  app.localdb.getArticle(articleId);
        if (localCopy && localCopy.status === app.status.ok){
            var localArticle = localCopy.entity;
            document.title = localArticle.name;
            $("#articleName").text(localArticle.name);
            $("#contentArea").html(localArticle.content);
            if($("#contentArea").html() == ""){
                $("#contentArea").html("<p>a</p><p></p>");
            }
        }
        else{
            var url = "rest/article/" + articleId;

            $.ajax({
                url: url,
                headers: { 'x-auth-token': sessionStorage.token },
                type: 'GET'
            }).done(function(data){
                document.title = data.name;
                $("#articleName").text(data.name);
                $("#contentArea").html(data.content);
                if($("#contentArea").html() == ""){
                    $("#contentArea").html("<p>a</p><p></p>");
                }
            });
        }
     


        $("#diaChangeHeight").dialog({
            autoOpen: false,
            modal: true,
            width: 300,
            height: 300
        });

        $("#dialogInsertTable").dialog({
            autoOpen: false,
            modal: true,
            width: 300,
            height: 300

        });

        $('#contentArea').keydown(function(event){
            if (event.keyCode == 9){
                event.preventDefault();
                var range = window.getSelection().getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode("  "));

            }
        });

        $('#btnTable').click(function(){

            var range = window.getSelection().getRangeAt(0);

            $("#dialogInsertTable").data('ran', range).dialog('open');
        });

        $('#btnCreateTable').click(function(){
            var ran =  $("#dialogInsertTable").data('ran');

            var rows = Number($('#tbxTableRows').val());
            var cols = Number($('#tbxTableColumns').val());
            var hasHeader = $('#cbxHasHeader:checked').length;


            var tableHTML = '<table>';
            if (hasHeader > 0){
                var headerRow = '<tr>';
                for (colCount=0; colCount < cols; colCount++){
                    headerRow = headerRow + '<th></th>';
                }
                headerRow = headerRow + '</tr>';
            }
            tableHTML = tableHTML + headerRow;
            for (rowCount = 0; rowCount < rows; rowCount++){
                var rowHtml = '<tr>';
                for (colCount=0; colCount < cols; colCount++){
                    rowHtml = rowHtml + '<td></td>';
                }
                rowHtml = rowHtml + '</tr>';
                tableHTML = tableHTML + rowHtml;
            }
            tableHTML = tableHTML + '</table>';

            var newElement = document.createElement('div');
            newElement.innerHTML = tableHTML;

            ran.deleteContents();
            ran.insertNode(newElement);

            $("#dialogInsertTable").dialog('close');
        });

        $('#btnCancelTable').click(function(){
            $("#dialogInsertTable").dialog('close');
        });



        $("#dialogInsertImage").dialog({
            autoOpen: false,
            modal: true,
            width: 400,
            height: 150,
            open: function(){
                $.ajaxSetup({cache: false});
                $("#fileInputContainer").html('<form enctype="multipart/form-data"><input type="file" id="fileUploader" name="theFile" /><br /><input type="button" id="btnInsertImage" value="Insert" /><input type="button" id="btnCancelImageDialog" value="Cancel" /></form>');
            }

        });

        $('#btnOpenImageDialog').click(function () {
            var range = window.getSelection().getRangeAt(0);
            //   alert(range);
            $("#dialogInsertImage").data("range", range).dialog('open');

        });

        $(document).on("click", "#btnCancelImageDialog", function () {
            $("#dialogInsertImage").dialog('close');
        });
        $(document).on("click", "#btnInsertImage", function () {
            var theFile = document.getElementById("fileUploader").files[0];
            if (!theFile) return;
            var formData = new FormData();
            //		formData.append(theFile.name, theFile);
            formData.append("fileUploader", theFile);

            var request = new XMLHttpRequest();
            request.open('POST', '/rest/file');
            //      request.setRequestHeader("Content-Type", "multipart/form-data");
            request.setRequestHeader("X-File-Name", theFile.name);
            request.setRequestHeader("X-File-Size", theFile.size);
            request.setRequestHeader("X-File-Type", theFile.type);
            request.setRequestHeader("X-File-ArticleId", articleId);
            request.setRequestHeader("x-auth-token", sessionStorage.token);

            request.onreadystatechange = function () { // Simple event handler
                if (request.readyState === 4){
                    //   alert(request.responseText);

                    var range = $("#dialogInsertImage").data("range");
                    var theId = request.responseText;
                    var src = '/rest/file/unsecured/' + theId;
                    insertImg(range, src, theId);

                    $("#dialogInsertImage").dialog('close');
                }
            };

            request.send(formData);
        });
        $(document).on('change', '#paragraph', function(){
            var selectedVal = $('#paragraph').val();
            switch (selectedVal){
                case 'heading1':
                    ApplyBlockStyle('h1');
                    break;
                case 'heading2':
                    ApplyBlockStyle('h2');
                    break;
                case 'heading3':
                    ApplyBlockStyle('h3');
                    break;
                case 'heading4':
                    ApplyBlockStyle('h4');
                    break;
                case 'normal':
                    ApplyBlockStyle('p');
                    break;
            }
            $('#paragraph').val('-');
        });

        $(document).on('change', '#coding', function(){
            var selectedVal = $('#coding').val();
            switch (selectedVal){
                case 'code':
                    //	insertTag('code');
                    formatCode('code');
                    break;
                case 'badCode':
                    insertTag('badCode');
                    break;
                case 'script':
                    insertTag('script');
                    break;
            }
            $('#coding').val('-');

        });
        $(document).on("click", "#btnSaveContent", function(){
            var imageUrl = "<img src='images/busy_indicator.gif' alt='busy' style='width:16px; height:16px' />";

            $('#saveIndicator').html(imageUrl);
            $('#saveIndicator').show();

            var para = {};
            para.id = articleId;
            para.content = $("#contentArea").html();

            $.ajax({
                type: "PUT",
                url: "rest/article/content",
                headers: { 'x-auth-token': sessionStorage.token },
                data: JSON.stringify(para),

                contentType: "application/json",
                success: function (response, status, xhr) {
                    $('#saveIndicator').html("<span style='color:green;'>Saved</span>").fadeOut(3000);
                },
                error: function (xhr, error) {
                    $('#saveIndicator').html("<span style='color:red;'>Saving Failed</span>" + xhr.responseText);
                }
            });
        });

        $(document).on("click", "#btnHTML", function(){
            var theHtml = $("#contentArea").html().replace(/&lt;/g, '&amp;lt;').replace(/&gt;/g, '&amp;gt;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            $("#contentArea").html(theHtml);
        });
        $(document).on("click", "#btnText", function(){
            var theHtml = $("#contentArea").html().replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;lt;/g, '&lt;').replace(/&amp;gt;/g, '&gt;');
            $("#contentArea").html(theHtml);
        });
        $(document).on("click", "#btnClear", function(){
            if (confirm("All contents will be discarded, continue?"))
                $("#contentArea").html('<p>a</p><p></p>');
        });


        HeightSetReturnAsDefault();
  	  
  	function InitInlineStyleButtons(){
        $("#btnBold").click(function(){ editStyle('bold'); });
        $("#btnUnderline").click(function(){ editStyle('underline');});
        $("#btnItalize").click(function(){ editStyle('italic');});
    }
    function InitBlockStyleButtons(){
        $("#btnHeading1").click(function(){ApplyBlockStyle('h1');});
        $("#btnHeading2").click(function(){ApplyBlockStyle('h2');});
        $("#btnHeading3").click(function(){ApplyBlockStyle('h3');});
        $("#btnNormal").click(function(){ApplyBlockStyle('p');});
        $("#btnUl").click(function(){insertTag('ul');});
        $("#btnOl").click(function(){ insertTag('ol');});
    }
    function replaceSelectedText(replacementText) {
        var sel, range;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.rangeCount) {
                range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(replacementText));
            }
        } else if (document.selection && document.selection.createRange) {
            range = document.selection.createRange();
            range.text = replacementText;
        }
    }

    function btnShowHeightDialog_Click(){
        // get current height value
        $("input#tbxNewHeight", "#diaChangeHeight").val($("#contentArea").css("max-height"));
        $("#diaChangeHeight").dialog('open');
    }
    function btnSaveNewHeight_Click(){
        // need validation for numbers / ranges here

        // actually this dialog may not be needed if the window.resize event can be detected and hooked up with a function that change the div size accordingly.

        // and the dialog can be a multi-function panel.

        $("#contentArea").css("max-height", $('#tbxNewHeight').val()/*+'px'*/); 
        $("#diaChangeHeight").dialog('close');
    }

    function HeightSetReturnAsDefault(){
        $("#tbxNewHeight").keydown(function(ev){
            if (ev.keyCode == 13){
                btnSaveNewHeight_Click();
            }
        });
    }
  });
  	
    </script>

</body>
</html>